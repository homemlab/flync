#!/bin/bash
version=0.7.0

echo -e '\n'Built with Ensembl BDGP6.32 release '('D. melanogaster')'

set -e
echo -e '\n'SOFTWARE VERSION $version'\n'
echo -e "Ricardo F. dos Santos <ricardo.santos@nms.unl.pt>\n"


ARGS=$(getopt -a --options d:l:s:g:a:t:m:c:h -- "$@")

# Constant or default variables ""
appdir=/bin/app
threads=2
mapcutoff=50
progfile=$appdir/scripts/vlookup.awk

usage="$(basename "$0") [-d DIRECTORY] [-l LIST] [OPT ARGS -sgatm] | [-h]

Discovery of Long Intergenic Non-Coding Transcripts:
    -d  <path>  Directory to which the results will be outputed to.

    -l  <file>  File with list of SRA accession numbers one per line.

    -s  <str>   (OPTIONAL) Split mode: Run specific parts of the analysis pipeline. Available options are:
                  [map] : Download and map reads against the provided accessions.
                  [map-stats] : Preform the analysis of the mapping statistics and prepares files for assembly step.
                                (Requires [map] to be run beforehand).
                  [assembly] : Perform assembly step and coding probability assessment. Also outputs final results.
                                (Requires [map] & [map-stats]).
                  [kall] : Perform the whole pipeline and run a pseudoalignment against the newly discovered lincRNAs.
                                (Requires -c <metadata.csv>)
                  [clean] : Intended to remove unecessary files after complete run. Will delete data/ folder.

    -g  <file>  (OPTIONAL) File in .fa format of the genome sequence to be used. If not provided, the more recent will be downloaded from Ensembl.org at the date of version build.

    -a  <file>  (OPTIONAL) File in .gtf format of the genome annotation to be used. If not provided, the more recent will be downloaded from Ensembl.org at the date of version build.

    -t  <int>   (OPTIONAL) Number of threads to use during discovery (default is 2).

    -m  <int>   (OPTIONAL) Minimum percentage of reads aligned to genome during hisat2 mapping (default is 50).

    -h          Show this help message and exit."

options='d:l:s:g:a:t:m:c:h'
while getopts $options option; do
  case "$option" in
    d) workdir=$(readlink -f $OPTARG'/');;
    l) sra=$(readlink -f $OPTARG);;
    s) mode=$OPTARG;;
    g) genome=$(readlink -f $OPTARG);;
    a) annot=$(readlink -f $OPTARG);;
    t) threads=$OPTARG;;
    m) mapcutoff=$OPTARG;;
    c) metadata=$(readlink -f $OPTARG);;
    h) echo "$usage"; exit;;
    :) printf "missing argument for -%s\n" "$OPTARG" >&2; echo "\n$usage" >&2; exit 1;;
   \?) printf "illegal option: -%s\n" "$OPTARG" >&2; echo "\n$usage" >&2; exit 1;;
  esac
done

# mandatory arguments
if [ ! "$workdir" ] || [ ! "$sra" ]; then
  echo "Mandatory arguments -d and -l must be provided"
  echo "$usage" >&2; exit 1
fi

if ! [[ -d "$workdir" ]]; then
  mkdir $workdir
fi

# Test if variables are what they are suposed to be #
int='^[0-9]+$'

if ! [[ -d $workdir ]]; then
  echo "-d must be a DIRECTORY to output results and temp files"
  echo "$usage" >&2; exit 1
elif ! [[ -f $sra ]]; then
  echo "-l must be a FILE, usually a .txt file, with SRA accession numbers (SRR######, one per line, last line required to be empty)"
  echo "$usage" >&2; exit 1
elif ! [[ $threads =~ $int ]]; then
  echo "-t must be an INTEGER with the number of threads to be created during the process (recomended max = number of cores)"
  echo "$usage" >&2; exit 1
elif ! [[ $mapcutoff =~ $int ]]; then
  echo "-m must be an INTEGER defining the minimum percentage of aligned reads for a run to be considered for transcriptome assembly"
  echo "$usage" >&2; exit 1
fi

# Checking if user supplied genome/annotation files
if [[ -z $genome ]]; then
  if ! [[ -z $annot ]]; then
    echo "To avoid compatibility errors .fa and .gtf files should com from same assembly. Using pre-built genome assembly"
    bash $appdir/scripts/get-genome.sh $appdir
    genome=$appdir/genome/genome.fa
    annot=$appdir/genome/genome.gtf
  else
    bash $appdir/scripts/get-genome.sh $appdir
    genome=$appdir/genome/genome.fa
    annot=$appdir/genome/genome.gtf
  fi
else
  if [[ -z $annot ]];then
    echo "To avoid compatibility errors .fa and .gtf files should com from same assembly. Using pre-built genome assembly"
    bash $appdir/scripts/get-genome.sh $appdir
    genome=$appdir/genome/genome.fa
    annot=$appdir/genome/genome.gtf
  else
    if ! [[ -f $annot ]]; then
      echo "-a must be a FILE in the .gtf format"
      echo "$usage" >&2; exit 1
    elif ! [[ -f $genome ]]; then
      echo "-g must be a FILE in the .fa format"
      echo "$usage" >&2; exit 1
    else
      echo "Using user supplied Genome/Annoation assembly"
      rm -rf $appdir/genome/genome*
      cp -f $genome $appdir/genome/genome.fa
      cp -f $annot $appdir/genome/genome.gtf
    fi
  fi
fi

if [[ $mode = "map" ]]; then
  bash $appdir/scripts/build-index.sh $appdir $threads
  wait
  bash $appdir/scripts/get-sra-info.sh $workdir $sra
  wait
  bash $appdir/scripts/map-sra-list.sh $workdir $sra $threads $appdir
elif [[ $mode = "map-stats" ]]; then
  bash $appdir/scripts/pre-process-mapping-stats.sh $workdir
  wait
  python3 $appdir/scripts/map-stats.py $mapcutoff $workdir
elif [[ $mode = "assembly" ]]; then
  sra2=$workdir/results/filtered_list.txt
  bash $appdir/scripts/transcriptome-assembly.sh $workdir $sra2 $appdir
  wait
  bash $appdir/scripts/coding-prob.sh $workdir
  wait
  bash $appdir/scripts/post-process-transcript-assembly.sh $workdir $progfile
elif [[ $mode = "clean" ]]; then
  rm -rf $workdir/data
elif [[ $mode = "kall" ]]; then
  if [ ! "$metadata" ]; then
    echo "Mandatory arguments -c must be provided"
    echo "$usage" >&2; exit 1
  else
    bash $appdir/scripts/build-index.sh $appdir $threads
    wait
    bash $appdir/scripts/get-sra-info.sh $workdir $sra
    wait
    bash $appdir/scripts/map-sra-list.sh $workdir $sra $threads $appdir
    wait
    bash $appdir/scripts/pre-process-mapping-stats.sh $workdir
    wait
    python3 $appdir/scripts/map-stats.py $mapcutoff $workdir
    sra2=$workdir/results/filtered_list.txt
    wait
    bash $appdir/scripts/transcriptome-assembly.sh $workdir $sra2 $appdir
    wait
    bash $appdir/scripts/coding-prob.sh $workdir
    wait
    bash $appdir/scripts/post-process-transcript-assembly.sh $workdir $progfile
    wait
    bash $appdir/scripts/kallisto.sh $workdir $sra2 $appdir $threads
    wait
    bash $appdir/scripts/pre-process-sleuth.sh $workdir $sra2 $metadata
    metadata2=$workdir/results_dea/metadata.csv
    wait
    echo $workdir
    echo $metadata2
    Rscript $appdir/scripts/sleuth.r $workdir $metadata2
  fi
elif [[ -z $mode ]]; then
  bash $appdir/scripts/build-index.sh $appdir $threads
  wait
  bash $appdir/scripts/get-sra-info.sh $workdir $sra
  wait
  bash $appdir/scripts/map-sra-list.sh $workdir $sra $threads $appdir
  wait
  bash $appdir/scripts/pre-process-mapping-stats.sh $workdir
  wait
  python3 $appdir/scripts/map-stats.py $mapcutoff $workdir
  sra2=$workdir/results/filtered_list.txt
  wait
  bash $appdir/scripts/transcriptome-assembly.sh $workdir $sra2 $appdir
  wait
  bash $appdir/scripts/coding-prob.sh $workdir
  wait
  bash $appdir/scripts/post-process-transcript-assembly.sh $workdir $progfile
else
  echo "Available options for -s/--split are: [map], [map-stats], [assembly], [clean] or [kall]"
  echo "Run dlinct -h to get help message. To run whole analysis remove -s/--split flag" >&2; exit 1
fi

cp $workdir/assemblies/merged.gtf $workdir/results/merged-assembly.gtf